---
machine:
  python:
    version: 2.7.6
  environment:
    BEET_HOME: /beetbox
    BEET_BASE: /var/beetbox
    BEET_USER: ubuntu
dependencies:
  pre:
    - sudo cp -rf ~/$CIRCLE_PROJECT_REPONAME $BEET_HOME
    - sudo chmod +x $BEET_HOME/packer/scripts/beetbox.sh
    - $BEET_HOME/packer/scripts/beetbox.sh
test:
  override:
    - sudo cp -rf $BEET_HOME/* $BEET_BASE
    - sudo cp ~/$CIRCLE_PROJECT_REPONAME/.beetbox/config.yml $BEET_HOME/ansible/vagrant.config.yml
    - $BEET_HOME/ansible/build.sh
deployment:
  dev:
    branch: dev
    owner: drupalmel
    commands:
      - chmod +x ~/$CIRCLE_PROJECT_REPONAME/packer/scripts/deploy.sh
      - BEET_VERSION="0.1.$CIRCLE_BUILD_NUM" BEET_BOX=beetbox-dev BEET_TEMPLATE=template.json ~/$CIRCLE_PROJECT_REPONAME/packer/scripts/deploy.sh
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    owner: drupalmel
    commands:
      - chmod +x ~/$CIRCLE_PROJECT_REPONAME/packer/scripts/deploy.sh
      - BEET_VERSION="$CIRCLE_TAG" BEET_BOX=beetbox BEET_TEMPLATE=template.json ~/$CIRCLE_PROJECT_REPONAME/packer/scripts/deploy.sh
      - BEET_VERSION="$CIRCLE_TAG" BEET_BOX=beetbox-14.04 BEET_TEMPLATE=template-14.04.json ~/$CIRCLE_PROJECT_REPONAME/packer/scripts/deploy.sh
      - BEET_VERSION="$CIRCLE_TAG" BEET_BOX=beetbox-12.04 BEET_TEMPLATE=template-12.04.json ~/$CIRCLE_PROJECT_REPONAME/packer/scripts/deploy.sh
